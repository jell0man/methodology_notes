Most C2 frameworks, including Cobalt Strike, are capable of producing ready-to-run payloads in formats such as `.exe`, `.dll`, `.ps1`, and more, but know how to build your own payloads is beneficial.

## PE File Structure
Portable Executable (PE) file format holds necessary info about a program for the OS to load it into memory. Both `.exe` and `.dll` files are PEs

![[5cffff248cd671eb063343d8ce1a8538 3.png]]

#### DOS header
Fixed 64-byte structure called `IMAGE_DOS_HEADER` that exists at start of every PE file. 2 important ones:
	`e_magic`
		first member
		2-byte WORD
		always `4D 5A`, or `MZ` in ASCII
	`e_lfanew`
		last member
		4-byte LONG
		located at offset 3C
	![[4e18d4b8509739b640864584af443287.png]]
#### DOS stub
Only used when PE file is executed under MS-DOS.
	Prints "This program cannot be run in DOS mode"
	![[76235c546519432579bb83ce1949806e.png]]
Modern Windows loader uses the offset in `elfanew` to skip this and jump to NT headers
#### NT headers
The Windows SDK (software development kit) has two definitions for the NT header - `IMAGE_NT_HEADERS` for 32-bit PEs and `IMAGE_NT_HEADERS64` for 64-bit PEs.

PE signature
	4-byte DWORD
	fixed value of `50 45 00 00` (PE\0\0 in ASCII)

File Header -- `IMAGE_FILE_HEADER`
	Machine
		2-byte WORD
		indicates CPU architecture the PE is compiled for
		[Values](https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#machine-types)
	NumberOfSections
		WORD
		holds number of sections PE has
	SizeOfOptionalHeader
		2-byte WORD
		holds size of optional header
	Characteristics
		2-byte flag that describes some attributes of the PE
	![[d56698e6ece4ce71156e978790e4bb1b.png]]

Optional Header -- `IMAGE_OPTIONAL_HEADER32` or `IMAGE_OPTIONAL_HEADER64`
	Magic
		Value
		determines if PE32 or PE32+ (32 bit vs 64 bit)
	AddressOfEntryPoint
		address of PE entry point relative to image base when loaded into memory
	ImageBase
		base address for PE image
	NumberOfRvaAndSizes
		size of DataDirectory array
	DataDirectory
		array of `IMAGE_DATA_DIRECTORY` structures
	![[d8a35878a30ce2c91590a15d8918b386.png]]

#### Data directories
`IMAGE_DATA_DIRECTORY` structure contains 2 members
	VirtualAddress
		points to start of data directory structure
	Size

#### Sections
The PE sections contain the actual data and executable code of the program:

**.text** - executable code of program
**.data** - initialized data
**.bss** - uninitialized data
**.rdata** - read-only data 
**.rsrc** - resources used by program ie: images

Each section is appended to a header that describes it. Each section header contains a
	Name
		limited to 8-bytes
	VirtualSize
		total size when loaded into memory
	VirtualAddress
		memory address of section loaded into memory
	SizeOfRawData
		size as if stored on disc
	Characteristics
		set of flags that describe characteristics of the section

## Processes
A _program_ is a set of instructions that have been compiled into a PE file, typically `.exe` or `.dll`.Â  
A _process_ can be thought of as a container to hold the resources of a running program

Multiple APIs can be used to start a process
	[CreateProcessW](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw)
	[CreateProcessAsUserW](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessasuserw)
	[CreateProcessWithLogonW](https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithlogonw)
	![[0503c20bf907334087e1cb12935254cb.png]]

#### Threads
